{% extends 'layouts/admin_main.html' %}

{% block title %} Dashboard For Bank Users {% endblock title %}
<!-- Specific CSS goes HERE -->
{% block stylesheets %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

{% endblock stylesheets %}

{% block content %}
<style>
    footer{
    z-index: 999;
    position: fixed;
    bottom: 0;
    width: 100%; 
    background-color: #f0f0f0; 
    padding: 10px; 
    text-align: center; 
    }
.table tr td:nth-child(1){
    width: 150px;
}
label{
    padding-top: 1em;
}
input{
    width: 100%;
    height: 40px;
    border: none;
}
#profile_upload{
    margin-top: 2em;
}
.container{
    height: 780px;
}


:root {
    --motion-ease: cubic-bezier(0.68, -0.6, 0.32, 1.6);
    --motion-duration: 0.3s;
  }
  button {
    appearance: none;
    background: transparent;
    border: 0;
    color: #fff;
    cursor: pointer;
    font: inherit;
    font-weight: 500;
    line-height: 1;
    padding: 1em 1.5em;
    position: relative;
    transition: filter var(--motion-duration);
  }
  
  button:hover {
    filter: brightness(1.1);
  }
  
  button:active {
    filter: brightness(0.9);
  }
  
  button > span {
    display: block;
    position: relative;
    transition: transform var(--motion-duration) var(--motion-ease);
    z-index: 1;
  }
  
  button:hover > span {
    transform: scale(1.05);
  }
  
  button:active > span {
    transform: scale(0.95);
  }
  
  button > svg {
    fill: #950cde;
    position: absolute;
    top: -5%;
    left: -5%;
    width: 110%;
    height: 110%;
  }
  
  button > svg > path {
    transition: var(--motion-duration) var(--motion-ease);
  }
  
  button:hover > svg > path {
    d: path(
      "M0,0 C0,-5 100,-5 100,0 C105,0 105,100 100,100 C100,105 0,105 0,100 C-5,100 -5,0 0,0"
    );
  }
  
  button:active > svg > path {
    d: path(
      "M0,0 C30,10 70,10 100,0 C95,30 95,70 100,100 C70,90 30,90 0,100 C5,70 5,30 0,0"
    );
  }
  
    #pwdResetForm {
        display: none; /* Initially hide the password reset form */
    }
    #btn_pwd{
        float: left;
        margin-top: -4.3em;
    }
    tr td:nth-child(1){
        background-color: rgb(194, 192, 190);
        font-weight: 600;
        font-size: 1.1em;
    }
    tr td input{
        text-align: center;
        font-size: 1em;
    }
    footer{
        z-index: 999;
        position: fixed;
        bottom: 0;
        width: 100%; 
        background-color: #f0f0f0; 
        padding: 10px; 
        text-align: center; 
        }
    #profile_pic{
    width: 170px;
    height: 170px;
    border-radius: 30%;
    }
</style>
<body>
    <div class="container text-center">
    <br><br>
        <div class="row">
            <div class="col-lg-12">
                <h3>User Profile Settings</h3>
            </div>
        </div>
      <form method="POST" action="settings_admin" id="settingsForm" enctype="multipart/form-data">
        <div class="row">
            <div class="col-lg-4">
                {% for i in result %}
                <img src="{{i.half_photo}}" alt="profile" id="profile_pic" style="margin-top: -60px;"/><br><br>
                <input type="file" class="form-control rounded-2" name="half_photo" id="half_photo" accept="image/jpeg, image/jpg, image/png"/> 
                {% endfor %}  
                <input type="submit" class="btn btn-secondary">
            </div>
            <div class="col-lg-7">
                <table class="table table-bordered">
                    <tbody>
                        {% for row in result %}
                        <tr>
                            <td><label for="cid">CID</label></td>
                            <td><input type="text" value="{{ row['CID'] }}" name="cid" id="ciid" required></td>
                            <div id="cid-message" style="color: red;"></div>
                            <div id="cid-success" style="color: green;"></div>
                            <div id="cid-error" class="text-danger" style="display: none;">CID must be a 11-digit number.</div>
                        </tr>
                        <tr>
                            <td><label for="full_name">Full Name</label></td>
                            <td><input type="text" value="{{row['full_name']}}" name="full_name" required></td>
                        </tr>
                        <tr>
                            <td><label for="dob">DOB</label></td>
                            <td><input type="date" value="{{formatted_dob}}" id="dob" name="dob" required></td>
                        </tr>
                        <tr>
                            <td><label for="username">Username</label></td>
                            <td><input type="text" value="{{row['username']}}" name="username" required></td>
                        </tr>
                        <tr>
                            <td><label for="email">Email</label></td>
                            <td><input type="email" value="{{row['email']}}" name="email" required></td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </form>
    </div>
    <a href="#pwdResetForm">
    <button onclick="togglePwdReset()" id="btn_pwd">
        <span>Update Password</span>
        <svg viewBox="-5 -5 110 110" preserveAspectRatio="none" aria-hidden="true">
          <path d="M0,0 C0,0 100,0 100,0 C100,0 100,100 100,100 C100,100 0,100 0,100 C0,100 0,0 0,0"/>
        </svg>
    </button>
    </a>
    <div class="pwd_reset" id="pwdResetForm">
        <form id="change_pwd" method="POST">
            <div class="form-group row">
              <label for="old_password" class="col-sm-2 col-form-label">Old Password</label>
              <div class="col-sm-5">
                <input type="text" class="form-control" placeholder="Enter the old password" id="old_password" name="old_pwd">
                <span id="oldpasswordError" class="text-danger"></span>  
              </div>
            </div>
            <div class="form-group row">
                <label for="new_password" class="col-sm-2 col-form-label">New Password</label>
                <div class="col-sm-5">
                  <input type="text" class="form-control" id="new_password" placeholder="Enter the new password" name="new_pwd">
                  <span id="newpasswordError" class="text-danger"></span>  
                </div>
            </div>
            <div class="form-group row">
              <label for="inputPassword2" class="col-sm-2 col-form-label">Repeat Password</label>
              <div class="col-sm-5">
                <input type="text" class="form-control" id="repeat_password" placeholder="Repeat the new password" name="repeat_pwd">
                <span id="repeatpasswordError" class="text-danger"></span>  
                <span id="repeatpasswordSuccess" class="text-success"></span>  
            </div>
            </div>
            <div class="form-group row">
              <div class="col-sm-5">
                <button type="submit" class="btn btn-primary">Update</button>
              </div>
            </div>
          </form>
    </div>
</body>
<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<!-- jQuery library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10">

<script>
    function togglePwdReset() {
        var pwdResetForm = document.getElementById("pwdResetForm");
        var btn_pwd = document.getElementById("btn_pwd");
            pwdResetForm.style.display = "block";
            btn_pwd.style.display = "none";
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.getElementById("ciid").addEventListener("input", function(event) {
        var input = event.target.value;
        var numericInput = input.replace(/\D/g, ''); // Remove non-numeric characters
        if (numericInput.length !== 11) {
            document.getElementById("cid-error").style.display = "block";
        } else {
            document.getElementById("cid-error").style.display = "none";
        }
        event.target.value = numericInput; // Update input value with only numeric characters
    });
</script>
<script>
    // Get the value of the CID input field
var cid = document.getElementById('ciid').value;

    //for checking the CID inside the database
    $(document).ready(function() {
    $('#ciid').keyup(function() {
        var cid = $(this).val();
        
        // Send an AJAX request to check if CID exists
        $.ajax({
            url: '/check_cid/'+cid,
            method: 'GET',
            success: function(response) {
                if (response.exists) {
                    // CID does not exist, display message to the user
                    // CID exists, populate other fields
                    $('#username').val(response.username);
                    $('#full_name').val(response.full_name);
                    $('#email').val(response.email);
                    $('#date').val(response.dob);
                    $('#cid-message').text('CID found! Please change the CID').addClass('text-error').show();
                    $('#cid-success').text('CID Valid').addClass('text-sucess').hide();
                } else {
                    // Hide message if previously shown
                    $('#cid-success').text('CID Valid').addClass('text-sucess').show();
                    $('#cid-message').text('CID found! Please change the CID').addClass('text-error').hide();
                }
            }
        });
    });
});
</script>
<script>
    // Intercept form submission
    document.querySelector('#settingsForm').addEventListener('submit', function(event) {
      event.preventDefault(); // Prevent default form submission
  
      // Perform any necessary form validation here
      // For example, check if CID is a valid 11-digit number
      if ($('#cid-message').is(':visible')) {
        // If the text is visible, prevent form submission and display an error message
        Swal.fire("CID found! Please change the CID before submitting the form.");
        return;
    }
      // Show Swal modal for confirmation
      Swal.fire({
        icon: 'question',
        title: 'Are you sure?',
        text: 'Do you want to save changes?',
        showCancelButton: true,
        confirmButtonText: 'Yes, save changes',
        cancelButtonText: 'No, cancel'
      }).then((result) => {
        if (result.isConfirmed) {
          // If user confirms, submit the form
          if ($('#cid-message').text().trim() === '' || $('#cid-success').text().trim() === 'CID Valid') {
            this.submit(); // Actual form submission
          }
          else{
            // If CID is not valid, show an error message or perform any other action
                alert('Please ensure CID is valid.'); // Example of showing an error message
            }
        }
      });
    });
  </script>
<!--For Reseting Password-->
<script>
    $('#change_pwd').submit(function (event) {
        event.preventDefault();//avoids reloading the page
    // Clear previous error messages
    $("#oldpasswordError").text("");
    $("#newpasswordError").text("");
    $("#repeatpasswordError").text("");
    // Get the password and confirm password values
    var old_password = $("#old_password").val().trim();
    var new_password = $("#new_password").val().trim();
    var repeat_password = $("#repeat_password").val().trim();
    var isValid = true;

    if (old_password === "") {
      $("#oldpasswordError").text("Old password is required.");
      isValid = false;
    }else{
      $("#oldpasswordError").text("");
    }

    if (new_password === "") {
      $("#newpasswordError").text("New password is required.");
      isValid = false;
    }else{
        if (new_password !== repeat_password) {
      $("#repeatpasswordError").text("Passwords do not match.");
      $("#repeatpasswordSuccess").text("");
      isValid = false;
    }else{
      $("#repeatpasswordError").text("");
      $("#repeatpasswordSuccess").text("Passwords matched!");
      isValid = true;
    }
      $("#newpasswordError").text("");
    }
    if ($('#cid-message').is(':visible')) {
        // If the text is visible, prevent form submission and display an error message
        Swal.fire("CID found! Please change the CID before submitting the form.");
        return;
    }
    // Get the form data
    var formData = $(this).serialize();

    if(isValid){
    $.ajax({
        url: '/update_pwd',
        method: 'POST',
        data: formData, // Send the serialized form data
        success: function(response) {
            // Handle successful response
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: 'Request successful!',
                footer: JSON.stringify(response) // Display response in the footer
            }).then(function() {
                        // Reload the page after the user clicks "OK"
                        location.reload();
                    });
        },
        error: function(xhr, status, error) {
            var errorMessage = JSON.parse(xhr.responseText).error;
            // Handle error
            Swal.fire({
                icon: 'error',
                title: 'Error!',
                text: 'Request failed!',
                footer: errorMessage // Display error message in the footer
            }).then(function() {
                        location.reload();
                    });
        }
    });
}
  });
function cancelButtonFunc() {
  window.close();
}
</script>
{% endblock %}
