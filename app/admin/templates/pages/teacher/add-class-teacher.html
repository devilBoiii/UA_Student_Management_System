{% extends 'layouts/admin_mains.html' %}

{% block title %} Dashboard_HR_Addding_Class_Teacher {% endblock title %}
<!-- Specific CSS goes HERE -->
{% block stylesheets %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
{% endblock stylesheets %}

{% block content %}
<!-- partial:../../partials/_navbar.html -->

<!-- partial -->

<!-- partial:../../partials/_settings-panel.html -->
<!-- partial -->
<!-- partial:../../partials/_sidebar.html -->

<!-- partial -->
<style>
    .addClass, #remove_class_button{
        display: none;
    }
    .form-control-label {
        font-weight: 500;
        width: 100%;
        text-align: center;
        color: #333; /* Text color */
        font-size: 16px; /* Font size */
    }
    #cid-success{
        color: green;
    }
    #cid-message{
        color: red;
    }
</style>
<div class="main-panel">
    <div class="content-wrapper">
        <div class="row">
            <div class="col-12 grid-margin stretch-card">
                <div class="card">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card-body">
                                <form action="" id="user-form" method="post">
                                    <div class="modal-header" style="text-align: center;">
                                        <h5 class="modal-title" id="exampleModalLongTitle">Add Class Teacher</h5>
                                    </div>
                                    <div class="modal-body">
                                        <div class="pl-lg-4">
                                            <div class="row">
                                                <div class="col-lg-3">
                                                    <div class="form-group">
                                                        <input type="hidden" id="uu_id" name="uu_id">
                                                        <label class="form-control-label" for="cid">CID</label>
                                                        <input type="text" name="cid" id="ciid" class="form-control" placeholder="Enter CID">
                                                        <div id="cid-message"></div>
                                                        <div id="cid-success"></div>
                                                        <div id="cid-error" class="text-danger" style="display: none;">CID must be a 11-digit number.</div>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3">
                                                    <div class="form-group">
                                                        <label class="form-control-label" for="full_name">Full Name</label>
                                                        <input type="text" name="full_name" id="full_name" class="form-control" placeholder="Enter the full name" >
                                                    </div>
                                                </div>
                                                <div class="col-lg-3">
                                                    <div class="form-group">
                                                        <label class="form-control-label" for="email">Email
                                                            address</label>
                                                        <input type="email" name="email" id="email" class="form-control"
                                                            placeholder="email address" >
                                                    </div>
                                                </div>
                                                <div class="col-lg-3">
                                                    <div class="form-group">
                                                        <label class="form-control-label" for="date">DOB
                                                            address</label>
                                                        <input type="date" name="date" id="date" class="form-control">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-lg-4">
                                                    <div class="form-group">
                                                        <label class="form-control-label"
                                                            for="username">Username</label>
                                                        <input type="text" name="username" id="username"
                                                            class="form-control" placeholder="Username" required>
                                                    </div>
                                                </div>
                                                <div class="col-lg-4">
                                                    <div class="form-group">
                                                        <label class="form-control-label"
                                                            for="password">Password</label>
                                                        <input type="password" name="password" id="password"
                                                            class="form-control" required>
                                                    </div>
                                                </div>
                                                <div class="col-lg-4">
                                                    <div class="form-group">
                                                        <label class="form-control-label" for="role">Role</label>
                                                        <select name="role" id="role" class="form-control" required>
                                                            <option value="">Select Role</option>
                                                            <option value="class_teacher">Class Teacher</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                </div>
                                                <div class="row" id="classTeacher_div">
                                                    <div class="col-lg-4">
                                                        <div class="form-group row grade">
                                                            <label class="form-control-label" for="grade_0">Select Class</label>
                                                                <select class="form-control form-select classField" onchange="loadSection(this)" name="grade[0]" id="grade_0" required>
                                                                    <option value="">---Select One---</option>
                                                                                           
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-4" id="section_group">
                                                        <div class="form-group">
                                                            <label class="form-control-label" for="section_0">Select Section</label>
                                                            <select name="section[0]" onchange="loadSubject(this)" id="section_0" class="form-control" required>
                                                                <option value="">---Select Section---</option>

                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-4" id="subject_group" >
                                                        <div class="form-group">
                                                            <label class="form-control-label" for="subject_0">Select Subject</label>
                                                            <select name="subject[0]" id="subject_0" class="form-control" required>
                                                                <option value="">---Select Subject---</option>        
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="submit" id="save" class="btn btn-primary">Save</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- content-wrapper ends -->
    <!-- partial:../../partials/_footer.html -->

    <!-- partial -->
</div>
<!-- main-panel ends -->

<!-- page-body-wrapper ends -->

<!-- container-scroller -->
<!-- plugins:js -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js" integrity="sha512-AA1Bzp5Q0K1KanKKmvN/4d3IRKVlv9PYgwFPvm32nPO6QS8yH1HO7LbgB1pgiOxPtfeg5zEn2ba64MUcqJx6CA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    document.getElementById("ciid").addEventListener("input", function(event) {
        var input = event.target.value;
        var numericInput = input.replace(/\D/g, ''); // Remove non-numeric characters
        if (numericInput.length !== 11) {
            document.getElementById("cid-error").style.display = "block";
        } else {
            document.getElementById("cid-error").style.display = "none";
        }
        event.target.value = numericInput; // Update input value with only numeric characters
    });
</script>
<script>
    document.getElementById("ciid").addEventListener("input", function(event) {
        var input = event.target.value;
        var numericInput = input.replace(/\D/g, ''); // Remove non-numeric characters
        if (numericInput.length !== 11) {
            document.getElementById("cid-error").style.display = "block";
        } else {
            document.getElementById("cid-error").style.display = "none";
        }
        event.target.value = numericInput; // Update input value with only numeric characters
    });
</script>
<script>
    // Get the value of the CID input field
var cid = document.getElementById('ciid').value;

    //for checking the CID inside the database
    $(document).ready(function() {
    $('#ciid').keyup(function() {
        var cid = $(this).val();
        
        // Send an AJAX request to check if CID exists
        $.ajax({
            url: '/check_cid/'+cid,
            method: 'GET',
            success: function(response) {
                if (response.exists) {
                    // CID does not exist, display message to the user
                    // CID exists, populate other fields
                    $('#username').val(response.username);
                    $('#full_name').val(response.full_name);
                    $('#email').val(response.email);
                    $('#date').val(response.dob);
                    $('#cid-message').text('CID found! Please change the CID').addClass('text-error').show();
                    $('#cid-success').text('CID Valid').addClass('text-sucess').hide();
                    $('#save').hide()
                } else {
                    // Hide message if previously shown
                    $('#cid-success').text('CID Valid').addClass('text-sucess').show();
                    $('#cid-message').text('CID found! Please change the CID').addClass('text-error').hide();
                    $('#save').show()
                }
            }
        });
    });
});
</script>
<script>
    $(document).ready(() => {
        loadClass('grade_0');
    });


    const loadClass = (id) => {
        fetch('/dropDownClass')
            .then(response => response.json())
            .then(data => {
                // Populate the dropdown with the fetched data
                const gradeSelect = document.getElementById(`${id}`);
                data.forEach(classObj => {
                    const option = document.createElement('option');
                    option.value = classObj.id;
                    option.textContent = classObj.name;
                    gradeSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
    }

    const loadSection = (e) => {
        var numericPart = $(e).attr('id').split('_')[1];
    var grade = $("#grade_" + numericPart).val();
    var $sectionSelect = $("#section_" + numericPart);
    var $subjectSelect = $("#subject_" + numericPart);

    // Clear existing options before fetching and adding new ones
    $sectionSelect.empty();
    $subjectSelect.empty();

    fetch('/get_section/' + grade)
        .then(response => response.json())
        .then(data => {
            data.sort((a, b) => a.name.localeCompare(b.name));
            data.forEach((item, index) => {
                $sectionSelect.append(`<option value="${item.id}">${item.name}</option>`);
            });
        })
        .catch(error => {
            console.error('Error fetching data:', error);
        });
}

const loadSubject = (e) => {
    var numericPart = $(e).attr('id').split('_')[1];
    var section = $('#section_' + numericPart).val();
    var $subjectSelect = $('#subject_' + numericPart);

    // Clear existing options before fetching and adding new ones
    $subjectSelect.empty();

    fetch('/get_subjects/' + section)
        .then(response => response.json())
        .then(data => {
            data.forEach((item, index) => {
                $subjectSelect.append(`<option value="${item.id}">${item.name}</option>`);
            });
        })
        .catch(error => {
            console.error('Error fetching data:', error);
        });
}


</script>

<!--Function to save the datas inside the database-->
<script>
    $(document).ready(function() {
        $('#user-form').submit(function(event) {
            event.preventDefault();
            var formData = $(this).serialize();
            var submitBtn = $('#save');
            submitBtn.text('Loading...');
            $.ajax({
                type: 'POST',
                url: '/check_class_steam_sec',
                data: formData,
                success: function(response) {
                    if (response.exists) {
                        swal({
                            title: "Error!",
                            text: "Can't Create User Because The Class Teacher Already Exist",
                            icon: "error",
                            button: "OK",
                        }).then(function() {
                            // Change the text inside the button to "Save"
                            $('#save').text('Save');
                        });
                    } else {
                        $.ajax({
                            type: 'POST',
                            url: '/save_sub_teacher_hr',
                            data: formData,
                            success: function(response) {
                                swal({
                                    title: "Success!",
                                    text: "Data Saved Successfully!",
                                    icon: "success",
                                    button: "OK",
                                }).then(function() {
                                    setTimeout(function() {
                                        location.reload();
                                    }, 1000);
                                });
                            },
                            error: function(error) {
                                swal({
                                    title: "Error!",
                                    text: "Failed! Please Refresh & Try Again",
                                    icon: "error",
                                    button: "OK",
                                });
                                console.error('Error saving data:', error);
                            }
                        });
                    }
                },
                error: function(error) {
                    swal({
                        title: "Error!",
                        text: "Failed to check combination existence. Please try again.",
                        icon: "error",
                        button: "OK",
                    });
                    console.error('Error checking combination existence:', error);
                }
            });
        });
    });    
</script>
{% endblock content %}

<!-- Specific JS goes HERE -->
{% block javascripts %}

{% endblock javascripts %}