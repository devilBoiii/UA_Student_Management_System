{% extends 'layouts/admin_mains.html' %}

{% block title %} Dashboard_HR_Adding_Subject_Teacher {% endblock title %}
<!-- Specific CSS goes HERE -->
{% block stylesheets %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
{% endblock stylesheets %}

{% block content %}
<!-- partial:../../partials/_navbar.html -->

<!-- partial -->

<!-- partial:../../partials/_settings-panel.html -->
<!-- partial -->
<!-- partial:../../partials/_sidebar.html -->

<!-- partial -->
<style>
    .addClass, #remove_class_button{
        display: none;
    }
    .cid-success{
        color: green;
    }
</style>
<div class="main-panel">
    <div class="content-wrapper">
        <div class="row">
            <div class="col-12 grid-margin stretch-card">
                <div class="card">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card-body">
                                <form action="" id="user-form" method="post">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="exampleModalLongTitle">Add Subject Teacher</h5>

                                    </div>
                                    <div class="modal-body">
                                        <div class="pl-lg-4">
                                            <div class="row">
                                                <div class="col-lg-3">
                                                    <div class="form-group">
                                                        <input type="hidden" id="uu_id" name="uu_id">
                                                        <label class="form-control-label" for="cid">CID</label>
                                                        <input type="text" name="cid" id="ciid" class="form-control" placeholder="Enter CID">
                                                        <div id="cid-message" style="color: black;"></div>
                                                        <div id="cid-success"></div>
                                                        <div id="cid-error" class="text-danger" style="display: none;">CID must be a 11-digit number.</div>
                                                    </div>
                                                </div>
                                                <div class="col-lg-3">
                                                    <div class="form-group">
                                                    <input type="hidden" id="uu_id" name="uu_id">
                                                        <label class="form-control-label"
                                                            for="full_name">Full Name</label>
                                                        <input type="text" name="full_name" id="full_name"
                                                            class="form-control" placeholder="Enter the full name">
                                                    </div>
                                                </div>
                                                <div class="col-lg-3">
                                                    <div class="form-group">
                                                        <label class="form-control-label" for="email">Email
                                                            address</label>
                                                        <input type="email" name="email" id="email" class="form-control"
                                                            placeholder="email address" >
                                                    </div>
                                                </div>
                                                <div class="col-lg-3">
                                                    <div class="form-group">
                                                        <label class="form-control-label" for="date">DOB
                                                            address</label>
                                                        <input type="date" name="date" id="date" class="form-control">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-lg-4">
                                                    <div class="form-group">
                                                        <label class="form-control-label"
                                                            for="username">Username</label>
                                                        <input type="text" name="username" id="username"
                                                            class="form-control" placeholder="Username">
                                                    </div>
                                                </div>
                                                <div class="col-lg-4" id="password-field">
                                                    <div class="form-group">
                                                        <label class="form-control-label"
                                                            for="password">Password</label>
                                                        <input type="password" name="password" id="password"
                                                            class="form-control">
                                                    </div>
                                                </div>
                                                <div class="col-lg-4">
                                                    <div class="form-group">
                                                        <label class="form-control-label" for="role">Role</label>
                                                        <select name="role" id="role" class="form-control">
                                                            <option value="">Select Role</option>
                                                            <option value="subject_teacher">Subject Teacher</option>
                                                            
                                                        </select>
                                                    </div>
                                                </div>
                                                </div>
                                                <div class="row" id="subjectTeacher_div">
                                                    <div class="col-lg-4">
                                                        <div class="form-group row grade">
                                                            <label class="form-control-label" for="grade_0">Select Class</label>
                                                                <select class="form-control form-select classField" onchange="loadSection(this)" name="grade[0]" id="grade_0">
                                                                    <option value="">---Select One---</option>
                                                                                           
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-4" id="section_group">
                                                        <div class="form-group">
                                                            <label class="form-control-label" for="section_0">Select Section</label>
                                                            <select name="section[0]" onchange="loadSubject(this)" id="section_0" class="form-control">
                                                                <option value="">---Select Section---</option>

                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-4" id="subject_group" >
                                                        <div class="form-group">
                                                            <label class="form-control-label" for="subject_0">Select Subject</label>
                                                            <select name="subject[0]" id="subject_0" class="form-control">
                                                                <option value="">---Select Subject---</option>        
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="addClass row addedDiv" style="margin-left: 10px;">
                                                <div class="form-group col-lg-4">
                                                    <label for="gradeV" class="form-control-label">Select Class</label>
                                                    <select name="gradeV" id="gradeV" class="form-control classField" onchange="loadSection(this)">
                                                        <option value="">---Select Class---</option>
                                                    </select>
                                                </div>
                                                <div class="form-group col-lg-4">
                                                    <label for="sectionV" class="form-control-label">Select Section</label>
                                                    <select name="sectionV" id="sectionV" class="form-control" onchange="loadSubject(this)">
                                                        <option value="">---Select Section---</option>        
                                                    </select>
                                                </div>
                                                <div class="form-group col-lg-4">
                                                    <label for="subjectV" class="form-control-label">Select Subject</label>
                                                    <select name="subjectV" id="subjectV" class="form-control">
                                                        <option value="">---Select Subject---</option>        
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="moreClass"></div>
                                            </div>

                                        </div>
                                    </div>
                                    <div class="modal-footer">

                                        <button type="button" class="btn btn-secondary" id="add_class_button">Add Class</button>
                                        <button type="button" class="btn btn-secondary" id="remove_class_button">Remove Class</button>
                                        <button type="submit" id="save" class="btn btn-primary">Save</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
<!-- For Checking the CID count -->
<script>
    document.getElementById("ciid").addEventListener("input", function(event) {
        var input = event.target.value;
        var numericInput = input.replace(/\D/g, ''); // Remove non-numeric characters
        if (numericInput.length !== 11) {
            document.getElementById("cid-error").style.display = "block";
        } else {
            document.getElementById("cid-error").style.display = "none";
        }
        event.target.value = numericInput; // Update input value with only numeric characters
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    // Get the value of the CID input field
var cid = document.getElementById('ciid').value;

    //for checking the CID inside the database
    $(document).ready(function() {
    $('#ciid').keyup(function() {
        var cid = $(this).val();
        
        // Send an AJAX request to check if CID exists
        $.ajax({
            url: '/check_cid/'+cid,
            method: 'GET',
            success: function(response) {
                if (response.exists) {
                    // CID does not exist, display message to the user
                    // CID exists, populate other fields
                    $('#username').val(response.username);
                    $('#full_name').val(response.full_name);
                    $('#email').val(response.email);
                    $('#date').val(response.dob);
                    $('#cid-message').text('User Found! Can be used as a subject teacher').show();
                    $('#cid-success').text('').addClass('text-sucess').hide();
                    $('#password-field').hide();
                    $('#username').prop('readonly', true);
                    $('#date').prop('readonly', true);
                    $('#full_name').prop('readonly', true);
                    $('#email').prop('readonly', true);
                } else {
                    $('#cid-success').text('CID can be used').addClass('text-sucess').show();
                    $('#cid-message').text('').hide();
                    $('#password-field').show();
                    $('#username').prop('readonly', false);
                    $('#date').prop('readonly', false);
                    $('#full_name').prop('readonly', false);
                    $('#email').prop('readonly', false);
                }
            }
        });
    });
});

</script>
<script>
    //to check the cid response from the server
    $(document).ready(function() {
        // Attach keyup event listener to CID input field
        $('#ciid').keyup(function() {
            // Get the value of the CID input field
            var cid = $(this).val();
            
            // Send an AJAX request to check if CID exists
            $.ajax({
                url: '/check_cid', // Endpoint to check CID on the server
                method: 'POST',
                data: { cid: cid }, // Send CID data to the server
                success: function(response) {
                    // Check if CID exists
                    if (response.exists) {
                        // CID exists, show success message or update UI accordingly
                        $('#cid-error').text('CID is valid').removeClass('text-danger').addClass('text-success').show();
                        $('#password-field').hide();
                    } else {
                        // CID does not exist, show error message or update UI accordingly
                        $('#cid-error').text('CID does not exist').removeClass('text-success').addClass('text-danger').show();
                        $('#password-field').show();
                    }
                }
            });
        });
    });
    </script>
<script>
    $(document).ready(function() {
    let clickCount = 0;

     $("#add_class_button").click(function() {
        clickCount++;

        // if (clickCount >= 2) {
            let newContent = $(".addClass").clone().appendTo(".moreClass").removeClass("addClass");

            newContent.find('label[for="gradeV"]').attr('for', 'grade_' + clickCount);
            newContent.find('#gradeV').attr('id', 'grade_' + clickCount);
            newContent.find('select[name="gradeV"]').attr('name', 'grade['+clickCount+']');

            newContent.find('label[for="sectionV"]').attr('for', 'section_' + clickCount);
            newContent.find('#sectionV').attr('id', 'section_' + clickCount);
            newContent.find('select[name="sectionV"]').attr('name', 'section['+clickCount+']');
            
            newContent.find('label[for="subjectV"]').attr('for', 'subject_' + clickCount);
            newContent.find('#subjectV').attr('id', 'subject_' + clickCount);
            newContent.find('select[name="subjectV"]').attr('name', 'subject['+clickCount+']');

            loadClass(`grade_${clickCount}`);
            $("#remove_class_button").css("display", "block");

        // } 
        // else {
        //     $(".addClass").css("display", "block");
        //     $("#remove_class_button").css("display", "block");
        // }
    });
});

var removeButtonClickCount = 0;

// Attach a click event handler to the remove button
$("#remove_class_button").click(function() {
    // Increment the click count
    removeButtonClickCount++;

    // Check if there are any 'addedDiv' elements
    var addedDivExists = $('div.addedDiv').length > 0;

    // If 'addedDiv' exists, proceed with removing the last child
    if (addedDivExists) {
        var lengthDiv = $('div.addedDiv').children().length;
        console.log('LengthDiv: ', lengthDiv);
        $('div.addedDiv').children().last().remove();
    } else {
        console.log('No addedDiv elements found.');
    }

        // Log the click count
    console.log('Remove button clicked', removeButtonClickCount, 'times.');
    });


    $(document).ready(() => {
        loadClass('grade_0');
    });


    const loadClass = (id) => {
        fetch('/dropDownClass')
            .then(response => response.json())
            .then(data => {
                // Populate the dropdown with the fetched data
                const gradeSelect = document.getElementById(`${id}`);
                data.forEach(classObj => {
                    const option = document.createElement('option');
                    option.value = classObj.id;
                    option.textContent = classObj.name;
                    gradeSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
    }

    const loadSection = (e) => {
        var numericPart = $(e).attr('id').split('_')[1];
    var grade = $("#grade_" + numericPart).val();
    var $sectionSelect = $("#section_" + numericPart);
    var $subjectSelect = $("#subject_" + numericPart);

    // Clear existing options before fetching and adding new ones
    $sectionSelect.empty();
    $subjectSelect.empty();

    fetch('/get_section/' + grade)
        .then(response => response.json())
        .then(data => {
            data.sort((a, b) => a.name.localeCompare(b.name));
            data.forEach((item, index) => {
                $sectionSelect.append(`<option value="${item.id}">${item.name}</option>`);
            });
        })
        .catch(error => {
            console.error('Error fetching data:', error);
        });
}

const loadSubject = (e) => {
    var numericPart = $(e).attr('id').split('_')[1];
    var section = $('#section_' + numericPart).val();
    var $subjectSelect = $('#subject_' + numericPart);

    // Clear existing options before fetching and adding new ones
    $subjectSelect.empty();

    fetch('/get_subjects/' + section)
        .then(response => response.json())
        .then(data => {
            data.forEach((item, index) => {
                $subjectSelect.append(`<option value="${item.id}">${item.name}</option>`);
            });
        })
        .catch(error => {
            console.error('Error fetching data:', error);
        });
}


</script>

<!--Function to save the datas inside the database-->
<script>
    $(document).ready(function() {
        $('#user-form').submit(function(event) {
            event.preventDefault();
            var formData = $(this).serialize();
            var submitBtn = $('#save');
            submitBtn.text('Loading...');
            $.ajax({
                type: 'POST',
                url: '/check_class_sub_sec',
                data: formData,
                success: function(response) {
                    if (response.exists) {
                        swal({
                            title: "Error!",
                            text: "Can't Create User Because The Subject Teacher Already Exists",
                            icon: "error",
                            button: "OK",
                        }).then(function() {
                            // Change the text inside the button to "Save"
                            $('#save').text('Save');
                        });
                    } else {
                        $.ajax({
                            type: 'POST',
                            url: '/save_subject_teacher_hr',
                            data: formData,
                            success: function(response) {
                                swal({
                                    title: "Success!",
                                    text: "Data Saved Successfully!",
                                    icon: "success",
                                    button: "OK",
                                }).then(function() {
                                    setTimeout(function() {
                                        location.reload();
                                    }, 1000);
                                });
                            },
                            error: function(error) {
                                swal({
                                    title: "Error!",
                                    text: "Failed! Please Refresh & Try Again",
                                    icon: "error",
                                    button: "OK",
                                });
                                console.error('Error saving data:', error);
                            }
                        });
                    }
                },
                error: function(error) {
                    swal({
                        title: "Error!",
                        text: "Failed to check combination existence. Please try again.",
                        icon: "error",
                        button: "OK",
                    });
                    console.error('Error checking combination existence:', error);
                }
            });
        });
    });    

</script>
{% endblock content %}

<!-- Specific JS goes HERE -->
{% block javascripts %}

{% endblock javascripts %}